<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="valle-select">
  <template>

    <style>

      :host {
        display: inline-block;
        position: relative;
        overflow: hidden;
      }

      .visual-hidden {
        position: absolute;
        left: -10000px;
      }

    </style>

    <label id="label">[[label]]</label>
    
    <input
      type="text"
      disabled
      tabindex="-1"
      aria-readonly="true"
      aria-owns="listbox"
      aria-labelledby="label"
      placeholder=[[placeholder]]
      id="input">

    <button
      aria-haspopup="listbox"
      aria-expanded="false"
      aria-pressed="false"
      aria-labelledby="label button"
      aria-describedby="description"
      id="button">

    </button>

    <ul 
      role="listbox"
      tabindex="-1"
      style="display: none;"
      aria-labelledby="label"
      id="listbox">

      <slot></slot>

    </ul>

    <template is="dom-if" if={{_isNoError(error,helpertext)}}>
      <small id="description">[[helpertext]]</small>
    </template>

    <template is="dom-if" if=[[error]]>
      <span id="description" role="alert">
        [[errortext]]<small class="visual-hidden">: [[helpertext]]</small>
      </span>
    </template>

  </template>

  <script>
    class valleElement extends Polymer.Element {

      static get is() { return 'valle-select'; }

      constructor() {
        super();
        this.state = {
          lastSelectedOption: null,
          allOptions: Polymer.dom(this).querySelectorAll('valle-option')
        }
      }

      ready() {
        super.ready();

        this.$.button.addEventListener('click', this._toggleOpen.bind(this));
        this.$.button.addEventListener('keydown', this._keydownToggleOpen.bind(this));

        if (this.required) {
          this.setAttribute('aria-required', true);
          this.$.button.addEventListener('blur', this._validadeRequired.bind(this));
        }

        // Options controls
        // -----------------------------
        
        if(this.state.allOptions.length > 0) {
          this.state.allOptions.forEach((option, index) => {

            option.id = `listbox${index}`;

            if(option.hasAttribute('selected')) {
              this._setSelectedStateToOption(option);
            }
          
            option.addEventListener('click', () => {
              this._setSelectedStateToOption(option)
            });

            option.addEventListener('keydown', (event) => {
              this._keydownControlSelectedState(event, index)
            });

          });
        }

        this.options = this.state.allOptions;
        
      }

      _setSelectedStateToOption(option) {
        this.current = option;
        this.open = false;
      }

      _keydownControlSelectedState(event, index) {

        const pressUp = event.which == 38 || event.keyCode == 38;
        const pressDown = event.which == 40 || event.keyCode == 40;
        const pressHome = event.which == 36 || event.keyCode == 36;
        const pressEnd = event.which == 35 || event.keyCode == 35;
        const pressPageUp = event.which == 33 || event.keyCode == 33;
        const pressPageDown = event.which == 34 || event.keyCode == 34;
        const pressEsc = event.which == 27 || event.keyCode == 27;
        const pressSpace = event.which == 32 || event.keyCode == 32;
        const pressEnter = event.which == 13 || event.keyCode == 13;

        if (pressUp) {
          event.preventDefault();
          this._moveFocusToBackOption(index);
        }
        
        if (pressDown) {
          event.preventDefault();
          this._moveFocusToNextOption(index);
        }

        if (pressHome) {
          event.preventDefault();
          this._moveFocusToFirstOption();
        }

        if (pressEnd) {
          event.preventDefault();
          this._moveFocusToLastOption();
        }

        if (pressPageUp) {
          event.preventDefault();
          this._moveFocusToFirstOption();
        }

        if (pressPageDown) {
          event.preventDefault();
          this._moveFocusToLastOption();
        }

        if (pressEsc) {
          event.preventDefault();
          this._toggleOpen();
        }

        if (pressEnter) {
          event.preventDefault();
          this._toggleOpen();
        }

        if (pressSpace) {
          event.preventDefault();
          this._toggleOpen();
        }

      }

      _moveFocusToBackOption(currentIndex) {
        const isFisrt = currentIndex === 0;
        if(!isFisrt) this.state.allOptions[currentIndex - 1].focus();
      }

      _moveFocusToNextOption(currentIndex) {
        const isLast = currentIndex === this.state.allOptions.length - 1;
        if(!isLast) this.state.allOptions[currentIndex + 1].focus();
      }

      _moveFocusToFirstOption() {
        this.state.allOptions[0].focus();
      }

      _moveFocusToLastOption() {
        this.state.allOptions[this.state.allOptions.length - 1].focus();
      }

      _isNoError(error, helperText) {
        return !error && helperText;
      }

      _toggleOpen() {
        this.hasAttribute('open')
        ? this.removeAttribute('open')
        : this.setAttribute('open', 'true')
      }

      _toggleOpenObserver(boolean) {
        
        const listbox = this.$.listbox;
        const button = this.$.button;

        if(boolean) {

          listbox.style.display = "block";
          button.setAttribute('aria-expanded', 'true');
          button.setAttribute('aria-pressed', 'true');

           if (this.state.allOptions.length > 0) {
            this.state.allOptions[0].focus();

            this.state.allOptions.forEach((option) => {
              if (option.selected) option.focus();
            });
          }

        } else {
          listbox.style.display = "none"
          button.setAttribute('aria-expanded', 'false');
          button.setAttribute('aria-pressed', 'false');
          button.focus();
        }

      }

      _keydownToggleOpen(event) {
        const pressEnter = event.which == 13 || event.keyCode == 13;
        const pressUp = event.which == 38 || event.keyCode == 38;
        const pressDown = event.which == 40 || event.keyCode == 40;
        const pressArows = pressUp || pressDown;

        if (pressEnter) {
          event.preventDefault();
        }
        
        if (pressArows) {
          event.preventDefault();
          this._toggleOpen();
        }

      }

      _toggleDisableObserver(boolean) {

        const button = this.$.button;

        button.hasAttribute('disabled')
        ? button.removeAttribute('disabled')
        : button.setAttribute('disabled', 'true')

      }

      _validadeRequired() {
        if(!this.open) {

          const inputValue = this.$.input.value;
          const isEmpty = inputValue.length === 0;

          isEmpty
          ? this.setAttribute('error', true)
          : this.removeAttribute('error')

        }
      }

      _setSelectedObserver(option) {

        const optionValue = option.getAttribute('value'); // TODO: Reolve undefined result on option.value (option.value broken the element, but cant catch from unit tests)

        this.value = optionValue;
        this.$.input.value = optionValue;
        this.$.button.innerText = optionValue;

        this.$.listbox.setAttribute('aria-activedescendant', option.id);

        if(this.state.lastSelectedOption) this.state.lastSelectedOption.removeAttribute('selected');
        this.state.lastSelectedOption = option;

        if(this.error) this.removeAttribute('error');

      }

      static get properties() {
        return {
          label: String,
          helpertext: String,
          errortext: String,
          open: {
            type: Boolean,
            observer: '_toggleOpenObserver',
            reflectToAttribute: true
          },
          required: Boolean,
          disabled: {
            type: Boolean,
            observer: '_toggleDisableObserver',
            reflectToAttribute: true
          },
          placeholder: String,
          error: Boolean,
          value: String,
          options: Array,
          current: {
            type: String,
            observer: '_setSelectedObserver'
          }
        };
      }

    }

    window.customElements.define(valleElement.is, valleElement);
  </script>
</dom-module>
